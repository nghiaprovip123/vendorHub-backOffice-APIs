// ======================================================================
// PRISMA CLIENT
// ======================================================================
generator client {
  provider = "prisma-client-js"
}

// ======================================================================
// DATABASE
// ======================================================================
datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ======================================================================
// ENUMS
// ======================================================================
enum PricingType {
  FIXED
  HIDDEN
  DYNAMIC
  STAFF_TIERED
  QUOTE_BASED
}

enum CategoryLevel {
  LEVEL_1
  LEVEL_2
}

// ======================================================================
// TENANT (MULTI-TENANT ROOT)
// ======================================================================
model Tenant {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId
  name      String
  slug      String   @unique

  services  Service[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ======================================================================
// USER
// ======================================================================
model User {
  id           String    @id @map("_id") @default(auto()) @db.ObjectId
  email        String    @unique
  password     String
  name         String?
  userName     String?
  phonenumber  String?

  accessToken  String?
  refreshToken String?

  services     Service[] @relation("userServices")
}

// ======================================================================
// SELLER
// ======================================================================
model Seller {
  id        String    @id @map("_id") @default(auto()) @db.ObjectId
  storeName String

  services  Service[] @relation("sellerServices")
}

// ======================================================================
// SERVICE (CORE DOMAIN)
// ======================================================================
model Service {
  id          String   @id @map("_id") @default(auto()) @db.ObjectId

  // --- Tenant boundary ---
  tenantId    String?   @db.ObjectId
  tenant      Tenant?   @relation(fields: [tenantId], references: [id])

  // --- Ownership ---
  userId      String?  @db.ObjectId
  user        User?    @relation("userServices", fields: [userId], references: [id])

  sellerId    String?  @db.ObjectId
  seller      Seller?  @relation("sellerServices", fields: [sellerId], references: [id])

  // --- Identity ---
  code        String?
  title       String?
  description String?
  slug        String?

  // --- Categorization ---
  tags        String[]

  // --- Pricing behavior ---
  pricingType  PricingType? @default(FIXED)
  currency     String? @default("VND")
  displayPrice Boolean? @default(true)

  taxIncluded  Boolean? @default(true)
  taxRateBps   Int?       // basis points (1000 = 10%)

  // --- Time behavior ---
  durationMin     Int?
  bufferBeforeMin Int? @default(0)
  bufferAfterMin  Int? @default(0)

  // --- Capacity ---
  minStaffCount Int? @default(1)
  maxStaffCount Int? @default(1)

  // --- Booking rules ---
  isBookable      Boolean? @default(true)
  requiresDeposit Boolean? @default(false)
  depositAmount   Int?    // minor unit (VND)

  // --- Presentation ---
  featured       Boolean? @default(false)
  badge          String?
  highlightColor String?
  displayOrder   Int? @default(0)
  isActive       Boolean? @default(true)

  // --- SEO ---
  metaTitle       String?
  metaDescription String?

  // --- Relations ---
  pricingRules   ServicePricingRule[]
  medias         ServiceMedia[]
  evaluation     ServiceEvaluation[]
  rating         ServiceRating[]
  // --- Metadata ---
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     staffService[]

  @@unique([tenantId, code])
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, featured])
}

// ======================================================================
// VARIANT MEDIA
// ======================================================================
model ServiceMedia {
  id        String @id @map("_id") @default(auto()) @db.ObjectId

  tenantId  String? @db.ObjectId
  serviceId String? @db.ObjectId
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  url       String?
  alt       String?
  order     Int @default(0)

  createdAt DateTime @default(now())

  // @@index([tenantId, variantId])
}

model ServiceEvaluation {
  id String @id @map("_id") @default(auto()) @db.ObjectId
  serviceId String? @db.ObjectId
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  userId    String? @db.ObjectId
  evaluationContent  String?
  
  @@index([serviceId])

}

model ServiceRating {
  id String @id @map("_id") @default(auto()) @db.ObjectId
  serviceId String? @db.ObjectId
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  userId    String? @db.ObjectId
  st     Int?
  
  @@index([serviceId])
}

// ======================================================================
// SERVICE PRICING RULE
// ======================================================================
model ServicePricingRule {
  id        String @id @map("_id") @default(auto()) @db.ObjectId

  tenantId  String? @db.ObjectId
  serviceId String? @db.ObjectId
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  variantId String? @db.ObjectId
  staffId   String? @db.ObjectId

  pricingType PricingType

  // Context
  dayOfWeek Int?        // 0â€“6
  startTime String?     // "09:00"
  endTime   String?     // "18:00"
  seasonTag String?

  // Price (minor unit, VND)
  price     Int?
  priority  Int? @default(0)
  isActive  Boolean? @default(true)

  createdAt DateTime @default(now())

  @@index([tenantId, serviceId])
}

model staffService {
  id              String @id @map("_id") @default(auto()) @db.ObjectId
  
  staffId         String? @db.ObjectId
  staff           Staff? @relation(fields: [staffId], references: [id])
  
  serviceId       String? @db.ObjectId
  service         Service? @relation(fields: [serviceId], references: [id])
  @@unique([staffId, serviceId])
}

model Staff {
  id                String @id @map("_id") @default(auto()) @db.ObjectId
  fullName          String?
  avatar_url        String?
  timezone          String?
  workingHours      String[]
  isActive          Boolean? @default(true)
  isDeleted         Boolean? @default(false)
  services          staffService[]
}

model Category {
  id            String @id @map("_id") @default(auto()) @db.ObjectId
  name          String? 
  slug          String?
  parentId      String?  @db.ObjectId
  parent        Category? @relation("CategoryTree", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children      Category[] @relation("CategoryTree")
  level         CategoryLevel
  description   String?
  displayOrder  Int? @default(0)
  createAt      DateTime @default(now())
}